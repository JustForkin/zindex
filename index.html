<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>zindex - index your compressed text files</title>

    <meta name="description" content="A tool for indexing and querying your compressed text files">
    <meta name="author" content="Matt Godbolt">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

    <div class="slides">
        <section>
            <h1>zindex</h1>

            <h3>Scratching your own itch</h3>

            <p>
                <small><a href="https://github.com/mattgodbolt">@mattgodbolt</a> / <a
                        href="https://twitter.com/mattgodbolt">@mattgodbolt</a>
                </small>
            </p>
        </section>

        <section>
            <h2>My problem</h2>
            <ul>
                <li>5000+ read-only archived JSON log files on NFS</li>
                <li>Average 450MiB gzipped, 4GiB uncompressed</li>
                <li>Need to find entries by a unique ID</li>
            </ul>
        </section>

        <section>
            <h2>zgrep</h2>
            <pre><code>$ zgrep -E '^{"eventId":63181572,' audit.log.gz
{"eventId":63181572,...}
</code></pre>
            <ul class="fragment">
                <li>Takes 14 seconds</li>
                <li class="fragment">zgrep has to uncompress every byte of the file to search it!</li>
                <li class="fragment">Could index file</li>
                <li class="fragment">...but then would need to be able to seek within gzip file</li>
            </ul>
        </section>

        <section>
            <h2>Inside a gzipped file</h2>

            <ul>
                <li>Sequence of blocks</li>
                <li>Blocks may be uncompressed or compressed</li>
                <li>Compressed blocks use Huffman-encoded LZ77</li>
            </ul>
        </section>

        <section>
            <h2>LZ77 decoder</h2>

            <p>Each symbol can be:</p>
            <ul>
                <li>A literal byte (e.g. <span class="decomp">'A'</span> or <span class="decomp">'\xff'</span>)</li>
                <li>A back-reference and length (Copy 5, distance 3).
                    <ul>
                        <li>Limited to 32KiB back</li>
                    </ul>
                <li>The "end of block" marker</li>
            </ul>
        </section>

        <section>
            <h2>Example</h2>

            <p align="center">"<span class="decomp">Nom nom nom gzip files!!!!!</span>"</p>
            <table class="fragment">
                <tr>
                    <td>Compressed block</td>
                    <td>""</td>
                </tr>
                <tr>
                    <td>"<span class="decomp">Nom n</span>"</td>
                    <td>"<span class="new decomp">Nom n</span>"</td>
                </tr>
                <tr>
                    <td>Copy 7, distance 4</td>
                    <td>"<span class="decomp">Nom n</span><span class="decomp new">om nom&nbsp;</span>"</td>
                </tr>
                <tr>
                    <td>"<span class="decomp">gzip files!</span>"</td>
                    <td>"<span class="decomp">Nom nom nom&nbsp;</span><span class="decomp new">gzip files!</span>"</td>
                </tr>
                <tr>
                    <td>Copy 4, distance 1</td>
                    <td>"<span class="decomp">Nom nom nom gzip files!</span><span class="decomp new">!!!!</span>"</td>
                </tr>
                <tr>
                    <td>End of block</td>
                    <td>"<span class="decomp">Nom nom nom gzip files!!!!!</span>"</td>
                </tr>
            </table>
        </section>

        <section>
            <h2>Seeking</h2>

            <table class="comp">
                <tr>
                    <th>0</th>
                    <th>45632</th>
                    <th>88775</th>
                </tr>
                <tr>
                    <td class="comp a">Uncompressed 1</td>
                    <td class="comp b">Uncompressed 2</td>
                    <td class="comp c">Uncompressed 3</td>
                </tr>
            </table>
            <br>
            <table class="comp">
                <tr>
                    <th>0</th>
                    <th>3788</th>
                    <th>9876</th>
                </tr>
                <tr>
                    <td class="comp a">Comp block 1</td>
                    <td class="comp b">Comp block 2</td>
                    <td class="comp c">Comp block 3</td>
                </tr>
            </table>
            <br>
            <table class="fragment">
                <tr>
                    <th>Offset</th>
                    <th>gzip offset</th>
                    <th>Context</th>
                </tr>
                <tr>
                    <td class="comp b">45632</td>
                    <td class="comp b">3788</td>
                    <td class="comp a">...ressed 1</td>
                </tr>
                <tr>
                    <td class="comp c">88775</td>
                    <td class="comp c">9876</td>
                    <td class="comp b">...ressed 2</td>
                </tr>
            </table>
        </section>

        <section>
            <h2>zindex</h2>
            <ul>
                <li>Decompress, find line offsets and index</li>
                <li>Checkpoint gzip state every few MiB</li>
                <li>32KiB of data for checkpoint</li>
            </ul>
        </section>
        <section>
            <h2>zq</h2>
            <ul>
                <li>Look up line number in index</li>
                <li>Look up file offset of line in index</li>
                <li>Get latest checkpoint prior to offset</li>
                <li>Initialize gzip library with 32KiB context</li>
                <li>Skip forward until offset</li>
            </ul>
        </section>

        <section>
            <h2>Building an index</h2>
            <pre><code class="shell">$ zindex \
    --regex '^{"eventId":([0-9]+),' \
    --unique --numeric audit.log.gz</code></pre>
            <ul class="fragment">
                <li>Creates a SQLite index file</li>
                <li>1.6GiB compressed input, 63MiB index</li>
                <li>Takes 90s</li>
            </ul>
        </section>
        <section>
            <h2>Querying</h2>
            <pre><code class="shell">$ zq audit.log.gz 63181572
{"eventId":63181572,...}</code></pre>
            <ul class="fragment">
                <li>Takes 0.03s</li>
                <li>47,000% faster than zgrep (14s)</li>
            </ul>
        </section>

        <section>
            <h2>Questions?</h2>

            <p>
                <a href="https://github.com/mattgodbolt/zindex">github.com/mattgodbolt/zindex</a><br>
                <a href="https://twitter.com/mattgodbolt">@mattgodbolt</a>
            </p>
        </section>
    </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
            {
                src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/highlight/highlight.js', async: true, condition: function () {
                return !!document.querySelector('pre code');
            }, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            },
            {src: 'plugin/zoom-js/zoom.js', async: true},
            {src: 'plugin/notes/notes.js', async: true}
        ]
    });

</script>

</body>
</html>
